<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ vehicle.title }} - CarGPT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><a href="/" style="text-decoration: none; color: inherit;"><i class="fas fa-car"></i> CarGPT</a></h1>
                    <p class="subtitle">AI-Powered Vehicle Discovery & Valuation Platform</p>
                </div>
                <div class="header-actions">
                    <a href="/" class="btn btn-outline-light mr-2">
                        <i class="fas fa-arrow-left"></i> Back to Search
                    </a>
                    <a href="/favorites" class="btn btn-outline-light">
                        <i class="fas fa-heart"></i> Favorites ({{ favorites|length }})
                    </a>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container mt-4">
        <div class="row">
            <!-- Main Vehicle Info -->
            <div class="col-lg-8">
                <!-- Vehicle Header -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h2 class="mb-2">{{ vehicle.title }}</h2>
                                
                                <!-- Source Badge -->
                                <div class="mb-3">
                                    {% if vehicle.source == 'cars.com' %}
                                    <span class="badge badge-info badge-lg">
                                        <i class="fas fa-car"></i> Cars.com
                                    </span>
                                    {% else %}
                                    <span class="badge badge-primary badge-lg">
                                        <i class="fab fa-ebay"></i> eBay Motors
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Favorite Button -->
                            <button type="button" class="btn btn-outline-danger" 
                                    onclick="toggleFavorite({{ vehicle.id }})"
                                    id="favoriteBtn">
                                <i class="{% if is_favorite %}fas{% else %}far{% endif %} fa-heart"></i>
                                <span id="favoriteText">{% if is_favorite %}Saved{% else %}Save{% endif %}</span>
                            </button>
                        </div>
                        
                        <!-- Deal Rating -->
                        {% if vehicle.deal_rating %}
                        <div class="deal-badge mb-3 {% if vehicle.deal_rating == 'Great Deal' %}great-deal{% elif vehicle.deal_rating == 'Good Deal' %}good-deal{% elif vehicle.deal_rating == 'Fair Price' %}fair-price{% else %}high-price{% endif %}">
                            {% if vehicle.deal_rating == "Great Deal" %}
                            <i class="fas fa-star"></i> {{ vehicle.deal_rating }}
                            {% elif vehicle.deal_rating == "Good Deal" %}
                            <i class="fas fa-thumbs-up"></i> {{ vehicle.deal_rating }}
                            {% elif vehicle.deal_rating == "Fair Price" %}
                            <i class="fas fa-balance-scale"></i> {{ vehicle.deal_rating }}
                            {% else %}
                            <i class="fas fa-exclamation-triangle"></i> {{ vehicle.deal_rating }}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Vehicle Image -->
                <div class="card mb-4">
                    <div class="card-body text-center">
                        {% if vehicle.image_urls and vehicle.image_urls|length > 0 %}
                        <img src="{{ vehicle.image_urls[0] }}" 
                             alt="{{ vehicle.title }}" 
                             class="img-fluid rounded" 
                             style="max-height: 400px; width: auto;">
                        {% else %}
                        <div class="placeholder-image bg-light d-flex align-items-center justify-content-center rounded" 
                             style="height: 300px;">
                            <i class="fas fa-car fa-5x text-muted"></i>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Vehicle Specifications -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Vehicle Specifications</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% if vehicle.year %}
                            <div class="col-md-6 mb-3">
                                <strong>Year:</strong> {{ vehicle.year }}
                            </div>
                            {% endif %}
                            {% if vehicle.make %}
                            <div class="col-md-6 mb-3">
                                <strong>Make:</strong> {{ vehicle.make }}
                            </div>
                            {% endif %}
                            {% if vehicle.model %}
                            <div class="col-md-6 mb-3">
                                <strong>Model:</strong> {{ vehicle.model }}
                            </div>
                            {% endif %}
                            {% if vehicle.mileage %}
                            <div class="col-md-6 mb-3">
                                <strong>Mileage:</strong> {{ "{:,}".format(vehicle.mileage) }} miles
                            </div>
                            {% endif %}
                            {% if vehicle.condition %}
                            <div class="col-md-6 mb-3">
                                <strong>Condition:</strong> {{ vehicle.condition|title }}
                            </div>
                            {% endif %}
                            {% if vehicle.transmission %}
                            <div class="col-md-6 mb-3">
                                <strong>Transmission:</strong> {{ vehicle.transmission|title }}
                            </div>
                            {% endif %}
                            {% if vehicle.fuel_type %}
                            <div class="col-md-6 mb-3">
                                <strong>Fuel Type:</strong> {{ vehicle.fuel_type|title }}
                            </div>
                            {% endif %}
                            {% if vehicle.body_style %}
                            <div class="col-md-6 mb-3">
                                <strong>Body Style:</strong> {{ vehicle.body_style|title }}
                            </div>
                            {% endif %}
                            {% if vehicle.exterior_color %}
                            <div class="col-md-6 mb-3">
                                <strong>Exterior Color:</strong> {{ vehicle.exterior_color|title }}
                            </div>
                            {% endif %}
                            {% if vehicle.interior_color %}
                            <div class="col-md-6 mb-3">
                                <strong>Interior Color:</strong> {{ vehicle.interior_color|title }}
                            </div>
                            {% endif %}
                            <div class="col-md-6 mb-3">
                                <strong>Location:</strong> {{ vehicle.location }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Questions Section -->
                {% if vehicle.buyer_questions and vehicle.buyer_questions|length > 0 %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-question-circle"></i> Smart Questions to Ask</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Our AI suggests these questions to help you make an informed decision:</p>
                        <ul class="list-group list-group-flush">
                            {% for question in vehicle.buyer_questions %}
                            <li class="list-group-item border-0 px-0">
                                <i class="fas fa-chevron-right text-primary mr-2"></i>{{ question }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}
                
                <!-- Contact Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-envelope"></i> Contact About This Vehicle</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <button type="button" class="btn btn-outline-info btn-block" onclick="generateMessage({{ vehicle.id }}, 'inquiry')">
                                    <i class="fas fa-comment"></i> Generate Inquiry Message
                                </button>
                            </div>
                            <div class="col-md-6 mb-3">
                                <button type="button" class="btn btn-outline-success btn-block" onclick="showOfferModal({{ vehicle.id }}, {{ vehicle.price }})">
                                    <i class="fas fa-dollar-sign"></i> Make an Offer
                                </button>
                            </div>
                        </div>
                        
                        {% if vehicle.source == 'cars.com' %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Realistic Demo Data:</strong> This is a realistic Cars.com-style listing for demonstration purposes.
                            Use the message generators above to create professional inquiries.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Price Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-dollar-sign"></i> Pricing Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="price-main text-center mb-3">
                            <h3 class="text-primary">${{ "{:,.0f}".format(vehicle.price) }}</h3>
                            <small class="text-muted">Listed Price</small>
                        </div>
                        
                        {% if vehicle.estimated_value %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Market Value:</span>
                                <span class="font-weight-bold">${{ "{:,.0f}".format(vehicle.estimated_value) }}</span>
                            </div>
                            {% if vehicle.market_min and vehicle.market_max %}
                            <div class="d-flex justify-content-between">
                                <span>Price Range:</span>
                                <span>${{ "{:,.0f}".format(vehicle.market_min) }} - ${{ "{:,.0f}".format(vehicle.market_max) }}</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Price Progress Bar -->
                        {% if vehicle.market_min and vehicle.market_max %}
                        <div class="mb-2">
                            <small class="text-muted">Price Position:</small>
                            <div class="progress" style="height: 8px;">
                                {% set price_position = ((vehicle.price - vehicle.market_min) / (vehicle.market_max - vehicle.market_min)) * 100 %}
                                {% set price_position = [0, price_position]|max %}
                                {% set price_position = [100, price_position]|min %}
                                
                                {% if vehicle.deal_rating == "Great Deal" %}
                                <div class="progress-bar bg-success" style="width: {{ price_position }}%"></div>
                                {% elif vehicle.deal_rating == "Good Deal" %}
                                <div class="progress-bar bg-primary" style="width: {{ price_position }}%"></div>
                                {% elif vehicle.deal_rating == "Fair Price" %}
                                <div class="progress-bar bg-warning" style="width: {{ price_position }}%"></div>
                                {% else %}
                                <div class="progress-bar bg-danger" style="width: {{ price_position }}%"></div>
                                {% endif %}
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Low</small>
                                <small class="text-muted">High</small>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                        
                        {% if vehicle.valuation_source %}
                        <small class="text-muted">Valuation by {{ vehicle.valuation_source }}</small>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Vehicle Stats -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Vehicle Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <small class="text-muted">Views:</small>
                            <span class="float-right">{{ vehicle.view_count or 0 }}</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Listed:</small>
                            <span class="float-right">{{ vehicle.created_at.strftime('%b %d, %Y') if vehicle.created_at else 'N/A' }}</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Source:</small>
                            <span class="float-right">{{ vehicle.source|title }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Similar Vehicles -->
                {% if similar_vehicles %}
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-car"></i> Similar Vehicles</h5>
                    </div>
                    <div class="card-body">
                        {% for similar in similar_vehicles[:3] %}
                        <div class="media mb-3">
                            <div class="media-body">
                                <h6 class="mt-0 mb-1">
                                    <a href="/vehicle/{{ similar.id }}" class="text-decoration-none">
                                        {{ similar.title }}
                                    </a>
                                </h6>
                                <small class="text-muted">
                                    ${{ "{:,.0f}".format(similar.price) }} â€¢ {{ similar.location }}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if similar_vehicles|length > 3 %}
                        <div class="text-center">
                            <small class="text-muted">+{{ similar_vehicles|length - 3 }} more similar vehicles</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Message Modal (from main page) -->
    <div class="modal fade" id="messageModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messageModalTitle">Generated Message</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="negotiationPoints" class="alert alert-info" style="display: none;">
                        <h6>ðŸ’¡ Negotiation Points:</h6>
                        <ul id="pointsList"></ul>
                    </div>
                    <div class="form-group">
                        <label for="generatedMessage">Copy and customize this message:</label>
                        <textarea class="form-control" id="generatedMessage" rows="10" readonly></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="copyMessage()">ðŸ“‹ Copy to Clipboard</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Offer Modal (from main page) -->
    <div class="modal fade" id="offerModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Make an Offer</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="offerForm">
                        <input type="hidden" id="offerVehicleId">
                        <div class="form-group">
                            <label for="offerPrice">Your Offer ($):</label>
                            <input type="number" class="form-control" id="offerPrice" min="1" step="100" required>
                            <small class="text-muted">Listed price: $<span id="listedPrice"></span></small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="generateOfferMessage()">Generate Offer Message</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Copy functions from main page
        function toggleFavorite(vehicleId) {
            const formData = new FormData();
            formData.append('vehicle_id', vehicleId);
            
            fetch('/favorites/toggle', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const btn = document.getElementById('favoriteBtn');
                    const icon = btn.querySelector('i');
                    const text = document.getElementById('favoriteText');
                    
                    if (data.is_favorite) {
                        icon.className = 'fas fa-heart';
                        text.textContent = 'Saved';
                        showToast('Added to favorites!', 'success');
                    } else {
                        icon.className = 'far fa-heart';
                        text.textContent = 'Save';
                        showToast('Removed from favorites!', 'info');
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update favorites');
            });
        }
        
        // Message generation functions (copy from main page)
        function generateMessage(vehicleId, messageType) {
            document.getElementById('generatedMessage').value = 'Generating message...';
            document.getElementById('messageModalTitle').innerText = 'Generating Message...';
            document.getElementById('negotiationPoints').style.display = 'none';
            $('#messageModal').modal('show');
            
            const formData = new FormData();
            formData.append('vehicle_id', vehicleId);
            formData.append('message_type', messageType);
            
            fetch('/generate-message', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                document.getElementById('generatedMessage').value = data.message;
                document.getElementById('messageModalTitle').innerText = 
                    messageType === 'inquiry' ? 'Inquiry Message Template' : 'Offer Message Template';
                
                if (data.negotiation_points && data.negotiation_points.length > 0) {
                    const pointsList = document.getElementById('pointsList');
                    pointsList.innerHTML = data.negotiation_points.map(point => `<li>${point}</li>`).join('');
                    document.getElementById('negotiationPoints').style.display = 'block';
                } else {
                    document.getElementById('negotiationPoints').style.display = 'none';
                }
                
                $('#messageModal').modal('show');
            })
            .catch(error => {
                alert('Error generating message: ' + error);
            });
        }
        
        function showOfferModal(vehicleId, listedPrice) {
            document.getElementById('offerVehicleId').value = vehicleId;
            document.getElementById('listedPrice').innerText = listedPrice.toLocaleString();
            
            const suggestedOffer = Math.round(listedPrice * 0.92 / 100) * 100;
            document.getElementById('offerPrice').value = suggestedOffer;
            
            $('#offerModal').modal('show');
        }
        
        function generateOfferMessage() {
            const vehicleId = document.getElementById('offerVehicleId').value;
            const offerPrice = document.getElementById('offerPrice').value;
            
            if (!offerPrice) {
                alert('Please enter an offer price');
                return;
            }
            
            $('#offerModal').modal('hide');
            
            document.getElementById('generatedMessage').value = 'Generating offer message...';
            document.getElementById('messageModalTitle').innerText = 'Generating Offer...';
            document.getElementById('negotiationPoints').style.display = 'none';
            $('#messageModal').modal('show');
            
            const formData = new FormData();
            formData.append('vehicle_id', vehicleId);
            formData.append('message_type', 'offer');
            formData.append('offer_price', offerPrice);
            
            fetch('/generate-message', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                document.getElementById('generatedMessage').value = data.message;
                document.getElementById('messageModalTitle').innerText = 'Offer Message Template';
                
                if (data.negotiation_points && data.negotiation_points.length > 0) {
                    const pointsList = document.getElementById('pointsList');
                    pointsList.innerHTML = data.negotiation_points.map(point => `<li>${point}</li>`).join('');
                    document.getElementById('negotiationPoints').style.display = 'block';
                } else {
                    document.getElementById('negotiationPoints').style.display = 'none';
                }
                
                $('#messageModal').modal('show');
            })
            .catch(error => {
                alert('Error generating offer message: ' + error);
            });
        }
        
        function copyMessage() {
            const messageText = document.getElementById('generatedMessage');
            messageText.select();
            messageText.setSelectionRange(0, 99999);
            document.execCommand('copy');
            alert('Message copied to clipboard!');
        }
        
        function showToast(message, type = 'info') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : 'info'} position-fixed`;
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.innerHTML = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }
    </script>
</body>
</html>