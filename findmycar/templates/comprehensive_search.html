<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarGPT - Comprehensive Vehicle Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .search-header {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .filter-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--card-shadow);
        }
        
        .filter-section h5 {
            margin-bottom: 1rem;
            color: #333;
            font-weight: 600;
        }
        
        .preset-card {
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            height: 100%;
        }
        
        .preset-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }
        
        .preset-card.active {
            border-color: #667eea;
            background-color: #f0f4ff;
        }
        
        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: inline-block;
            margin: 2px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
        }
        
        .color-swatch.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px #667eea;
        }
        
        .body-style-icon {
            width: 60px;
            height: 40px;
            padding: 5px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 1.5rem;
        }
        
        .body-style-icon:hover {
            border-color: #667eea;
        }
        
        .body-style-icon.selected {
            border-color: #667eea;
            background-color: #f0f4ff;
        }
        
        .feature-checkbox {
            margin-bottom: 0.5rem;
        }
        
        .vehicle-card {
            transition: transform 0.2s;
            height: 100%;
            box-shadow: var(--card-shadow);
        }
        
        .vehicle-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .advanced-filters {
            display: none;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .search-stats {
            background: #e9ecef;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .suggestion-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .suggestion-item:hover {
            background: #f0f4ff;
        }
        
        .suggestion-type {
            font-size: 0.8rem;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-car"></i> CarGPT <span class="badge badge-warning">V2</span>
            </a>
            <div class="navbar-nav ml-auto">
                <a class="nav-link" href="#" data-toggle="modal" data-target="#savedSearchesModal">
                    <i class="fas fa-bookmark"></i> Saved Searches
                </a>
            </div>
        </div>
    </nav>

    <!-- Search Header -->
    <section class="search-header">
        <div class="container">
            <h1 class="mb-4">Find Your Perfect Vehicle</h1>
            
            <!-- Main Search Bar -->
            <div class="row">
                <div class="col-lg-10 mx-auto">
                    <div class="input-group input-group-lg position-relative">
                        <input type="text" id="searchQuery" class="form-control" 
                               placeholder="Search by make, model, or describe what you're looking for..."
                               autocomplete="off">
                        <div class="input-group-append">
                            <button class="btn btn-warning" type="button" onclick="performSearch()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                        <!-- Suggestions dropdown -->
                        <div id="searchSuggestions" class="dropdown-menu w-100" style="max-height: 300px; overflow-y: auto;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Presets -->
            <div class="row mt-4">
                <div class="col-lg-10 mx-auto">
                    <h5 class="mb-3">Quick Searches:</h5>
                    <div class="row">
                        {% for preset in presets[:4] %}
                        <div class="col-md-3 mb-2">
                            <div class="card preset-card" onclick="selectPreset('{{ preset.id }}')">
                                <div class="card-body p-3">
                                    <h6 class="card-title mb-1">{{ preset.name }}</h6>
                                    <small class="text-muted">{{ preset.description }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <!-- Filters Column -->
            <div class="col-lg-3">
                <button class="btn btn-primary btn-block mb-3 d-lg-none" onclick="toggleFilters()">
                    <i class="fas fa-filter"></i> Toggle Filters
                </button>
                
                <div id="filterPanel" class="d-lg-block">
                    <!-- Core Filters -->
                    <div class="filter-section">
                        <h5>Basic Filters</h5>
                        
                        <div class="form-group">
                            <label>Make</label>
                            <select id="makeFilter" class="form-control select2-multiple" multiple>
                                <option value="toyota">Toyota</option>
                                <option value="honda">Honda</option>
                                <option value="ford">Ford</option>
                                <option value="chevrolet">Chevrolet</option>
                                <option value="nissan">Nissan</option>
                                <option value="mazda">Mazda</option>
                                <option value="hyundai">Hyundai</option>
                                <option value="kia">Kia</option>
                                <option value="volkswagen">Volkswagen</option>
                                <option value="subaru">Subaru</option>
                                <option value="mercedes-benz">Mercedes-Benz</option>
                                <option value="bmw">BMW</option>
                                <option value="audi">Audi</option>
                                <option value="lexus">Lexus</option>
                                <option value="tesla">Tesla</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Year Range</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" id="yearMin" class="form-control" placeholder="Min" min="1900" max="2024">
                                </div>
                                <div class="col-6">
                                    <input type="number" id="yearMax" class="form-control" placeholder="Max" min="1900" max="2024">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Price Range</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" id="priceMin" class="form-control" placeholder="Min" step="1000">
                                </div>
                                <div class="col-6">
                                    <input type="number" id="priceMax" class="form-control" placeholder="Max" step="1000">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Mileage Range</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" id="mileageMin" class="form-control" placeholder="Min" step="1000">
                                </div>
                                <div class="col-6">
                                    <input type="number" id="mileageMax" class="form-control" placeholder="Max" step="1000">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Body Style -->
                    <div class="filter-section">
                        <h5>Body Style</h5>
                        <div class="d-flex flex-wrap">
                            <div class="body-style-icon" data-value="sedan" onclick="toggleBodyStyle(this)">
                                <i class="fas fa-car-side"></i>
                                <div><small>Sedan</small></div>
                            </div>
                            <div class="body-style-icon" data-value="suv" onclick="toggleBodyStyle(this)">
                                <i class="fas fa-truck"></i>
                                <div><small>SUV</small></div>
                            </div>
                            <div class="body-style-icon" data-value="truck" onclick="toggleBodyStyle(this)">
                                <i class="fas fa-truck-pickup"></i>
                                <div><small>Truck</small></div>
                            </div>
                            <div class="body-style-icon" data-value="coupe" onclick="toggleBodyStyle(this)">
                                <i class="fas fa-car"></i>
                                <div><small>Coupe</small></div>
                            </div>
                            <div class="body-style-icon" data-value="hatchback" onclick="toggleBodyStyle(this)">
                                <i class="fas fa-car"></i>
                                <div><small>Hatch</small></div>
                            </div>
                            <div class="body-style-icon" data-value="convertible" onclick="toggleBodyStyle(this)">
                                <i class="fas fa-car"></i>
                                <div><small>Convert</small></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Colors -->
                    <div class="filter-section">
                        <h5>Exterior Color</h5>
                        <div class="mb-2">
                            <small class="text-muted">Select colors to include:</small>
                        </div>
                        <div id="colorFilters">
                            <span class="color-swatch" style="background: black;" data-color="black" onclick="toggleColor(this)"></span>
                            <span class="color-swatch" style="background: white; border: 1px solid #ddd;" data-color="white" onclick="toggleColor(this)"></span>
                            <span class="color-swatch" style="background: silver;" data-color="silver" onclick="toggleColor(this)"></span>
                            <span class="color-swatch" style="background: gray;" data-color="gray" onclick="toggleColor(this)"></span>
                            <span class="color-swatch" style="background: red;" data-color="red" onclick="toggleColor(this)"></span>
                            <span class="color-swatch" style="background: blue;" data-color="blue" onclick="toggleColor(this)"></span>
                            <span class="color-swatch" style="background: green;" data-color="green" onclick="toggleColor(this)"></span>
                            <span class="color-swatch" style="background: #8B4513;" data-color="brown" onclick="toggleColor(this)"></span>
                            <span class="color-swatch" style="background: #F5DEB3;" data-color="beige" onclick="toggleColor(this)"></span>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Exclude colors:</small>
                            <input type="text" id="excludeColors" class="form-control form-control-sm" 
                                   placeholder="e.g., white, silver">
                        </div>
                    </div>
                    
                    <!-- Advanced Filters Toggle -->
                    <button class="btn btn-outline-primary btn-block mb-3" onclick="toggleAdvancedFilters()">
                        <i class="fas fa-cog"></i> Advanced Filters
                    </button>
                    
                    <!-- Advanced Filters -->
                    <div id="advancedFilters" class="advanced-filters">
                        <!-- Mechanical -->
                        <div class="filter-section">
                            <h5>Mechanical</h5>
                            
                            <div class="form-group">
                                <label>Transmission</label>
                                <select id="transmissionFilter" class="form-control" multiple>
                                    <option value="automatic">Automatic</option>
                                    <option value="manual">Manual</option>
                                    <option value="cvt">CVT</option>
                                    <option value="dual-clutch">Dual Clutch</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Drivetrain</label>
                                <select id="drivetrainFilter" class="form-control" multiple>
                                    <option value="fwd">FWD</option>
                                    <option value="rwd">RWD</option>
                                    <option value="awd">AWD</option>
                                    <option value="4wd">4WD</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Fuel Type</label>
                                <select id="fuelTypeFilter" class="form-control" multiple>
                                    <option value="gasoline">Gasoline</option>
                                    <option value="hybrid">Hybrid</option>
                                    <option value="plug-in hybrid">Plug-in Hybrid</option>
                                    <option value="electric">Electric</option>
                                    <option value="diesel">Diesel</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Features -->
                        <div class="filter-section">
                            <h5>Features</h5>
                            
                            <div class="feature-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="backup_camera" id="feat_backup_camera">
                                    <label class="form-check-label" for="feat_backup_camera">Backup Camera</label>
                                </div>
                            </div>
                            
                            <div class="feature-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="leather_seats" id="feat_leather_seats">
                                    <label class="form-check-label" for="feat_leather_seats">Leather Seats</label>
                                </div>
                            </div>
                            
                            <div class="feature-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="sunroof" id="feat_sunroof">
                                    <label class="form-check-label" for="feat_sunroof">Sunroof</label>
                                </div>
                            </div>
                            
                            <div class="feature-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="navigation" id="feat_navigation">
                                    <label class="form-check-label" for="feat_navigation">Navigation</label>
                                </div>
                            </div>
                            
                            <div class="feature-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="heated_seats" id="feat_heated_seats">
                                    <label class="form-check-label" for="feat_heated_seats">Heated Seats</label>
                                </div>
                            </div>
                            
                            <div class="feature-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="apple_carplay" id="feat_apple_carplay">
                                    <label class="form-check-label" for="feat_apple_carplay">Apple CarPlay</label>
                                </div>
                            </div>
                            
                            <div class="feature-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="third_row" id="feat_third_row">
                                    <label class="form-check-label" for="feat_third_row">Third Row Seating</label>
                                </div>
                            </div>
                            
                            <div class="feature-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="remote_start" id="feat_remote_start">
                                    <label class="form-check-label" for="feat_remote_start">Remote Start</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Efficiency -->
                        <div class="filter-section">
                            <h5>Fuel Efficiency</h5>
                            
                            <div class="form-group">
                                <label>Min City MPG</label>
                                <input type="number" id="mpgCityMin" class="form-control" placeholder="e.g., 25">
                            </div>
                            
                            <div class="form-group">
                                <label>Min Highway MPG</label>
                                <input type="number" id="mpgHighwayMin" class="form-control" placeholder="e.g., 30">
                            </div>
                        </div>
                        
                        <!-- History -->
                        <div class="filter-section">
                            <h5>Vehicle History</h5>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cleanTitleOnly">
                                <label class="form-check-label" for="cleanTitleOnly">Clean Title Only</label>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="noAccidents">
                                <label class="form-check-label" for="noAccidents">No Accidents</label>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="oneOwnerOnly">
                                <label class="form-check-label" for="oneOwnerOnly">One Owner Only</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Apply/Reset Buttons -->
                    <div class="mt-3">
                        <button class="btn btn-primary btn-block" onclick="performSearch()">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        <button class="btn btn-outline-secondary btn-block" onclick="resetFilters()">
                            <i class="fas fa-undo"></i> Reset All
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Results Column -->
            <div class="col-lg-9">
                <!-- Search Stats -->
                <div id="searchStats" class="search-stats" style="display: none;">
                    <div class="row align-items-center">
                        <div class="col">
                            <strong id="resultCount">0</strong> vehicles found
                            <span id="searchTime" class="text-muted"></span>
                        </div>
                        <div class="col-auto">
                            <select id="sortBy" class="form-control form-control-sm" onchange="performSearch()">
                                <option value="relevance">Relevance</option>
                                <option value="price_low">Price: Low to High</option>
                                <option value="price_high">Price: High to Low</option>
                                <option value="mileage_low">Mileage: Low to High</option>
                                <option value="year_new">Year: Newest First</option>
                                <option value="recent">Recently Added</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-sm btn-outline-primary" onclick="saveCurrentSearch()">
                                <i class="fas fa-bookmark"></i> Save Search
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Results Grid -->
                <div id="resultsContainer" class="row">
                    <!-- Welcome message when no search -->
                    <div class="col-12 text-center py-5">
                        <h3>Start your search above</h3>
                        <p class="text-muted">Use the search bar or select a preset to find your perfect vehicle</p>
                        
                        {% if popular_searches %}
                        <div class="mt-4">
                            <h5>Popular Searches:</h5>
                            {% for search in popular_searches %}
                            <button class="btn btn-outline-primary btn-sm m-1" onclick="searchFor('{{ search.query }}')">
                                {{ search.query }}
                            </button>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Pagination -->
                <nav id="pagination" style="display: none;">
                    <ul class="pagination justify-content-center">
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3">Searching vehicles...</p>
        </div>
    </div>
    
    <!-- Saved Searches Modal -->
    <div class="modal fade" id="savedSearchesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Saved Searches</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="savedSearchesList">
                        <p class="text-muted">No saved searches yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Search Modal -->
    <div class="modal fade" id="saveSearchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Search</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Search Name</label>
                        <input type="text" id="searchName" class="form-control" placeholder="e.g., Family SUV under 30k">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmSaveSearch()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        // Global variables
        let currentFilters = {};
        let currentQuery = '';
        let currentPage = 1;
        let selectedBodyStyles = new Set();
        let selectedColors = new Set();
        let selectedPreset = null;
        
        // Initialize on page load
        $(document).ready(function() {
            // Initialize Select2
            $('.select2-multiple').select2({
                placeholder: 'Select options',
                allowClear: true
            });
            
            // Setup search suggestions
            $('#searchQuery').on('input', debounce(fetchSuggestions, 300));
            
            // Handle enter key in search
            $('#searchQuery').on('keypress', function(e) {
                if (e.which === 13) {
                    performSearch();
                }
            });
            
            // Load saved searches if user ID exists
            loadSavedSearches();
        });
        
        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Fetch search suggestions
        async function fetchSuggestions() {
            const query = $('#searchQuery').val();
            if (query.length < 2) {
                $('#searchSuggestions').removeClass('show');
                return;
            }
            
            try {
                const response = await fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.suggestions && data.suggestions.length > 0) {
                    let html = '';
                    data.suggestions.forEach(suggestion => {
                        html += `
                            <a class="dropdown-item suggestion-item" href="#" onclick="selectSuggestion('${suggestion.value}')">
                                <div>${suggestion.display}</div>
                                <small class="suggestion-type">${suggestion.type}</small>
                            </a>
                        `;
                    });
                    $('#searchSuggestions').html(html).addClass('show');
                } else {
                    $('#searchSuggestions').removeClass('show');
                }
            } catch (error) {
                console.error('Error fetching suggestions:', error);
            }
        }
        
        // Select suggestion
        function selectSuggestion(value) {
            if (value.startsWith('preset:')) {
                const presetId = value.replace('preset:', '');
                selectPreset(presetId);
            } else {
                $('#searchQuery').val(value);
                performSearch();
            }
            $('#searchSuggestions').removeClass('show');
        }
        
        // Select preset
        function selectPreset(presetId) {
            selectedPreset = presetId;
            $('.preset-card').removeClass('active');
            $(`.preset-card`).each(function() {
                if ($(this).attr('onclick').includes(presetId)) {
                    $(this).addClass('active');
                }
            });
            performSearch();
        }
        
        // Toggle body style
        function toggleBodyStyle(element) {
            const value = $(element).data('value');
            if (selectedBodyStyles.has(value)) {
                selectedBodyStyles.delete(value);
                $(element).removeClass('selected');
            } else {
                selectedBodyStyles.add(value);
                $(element).addClass('selected');
            }
        }
        
        // Toggle color
        function toggleColor(element) {
            const color = $(element).data('color');
            if (selectedColors.has(color)) {
                selectedColors.delete(color);
                $(element).removeClass('selected');
            } else {
                selectedColors.add(color);
                $(element).addClass('selected');
            }
        }
        
        // Toggle advanced filters
        function toggleAdvancedFilters() {
            $('#advancedFilters').slideToggle();
        }
        
        // Toggle filters on mobile
        function toggleFilters() {
            $('#filterPanel').toggleClass('d-none d-lg-block');
        }
        
        // Build filters from UI
        function buildFilters() {
            const filters = {};
            
            // Basic filters
            const makes = $('#makeFilter').val();
            if (makes && makes.length > 0) {
                filters.make = makes.join(',');
            }
            
            if ($('#yearMin').val()) filters.year_min = $('#yearMin').val();
            if ($('#yearMax').val()) filters.year_max = $('#yearMax').val();
            if ($('#priceMin').val()) filters.price_min = $('#priceMin').val();
            if ($('#priceMax').val()) filters.price_max = $('#priceMax').val();
            if ($('#mileageMin').val()) filters.mileage_min = $('#mileageMin').val();
            if ($('#mileageMax').val()) filters.mileage_max = $('#mileageMax').val();
            
            // Body style
            if (selectedBodyStyles.size > 0) {
                filters.body_style = Array.from(selectedBodyStyles).join(',');
            }
            
            // Colors
            if (selectedColors.size > 0) {
                filters.exterior_color = Array.from(selectedColors).join(',');
            }
            
            const excludeColors = $('#excludeColors').val().trim();
            if (excludeColors) {
                filters.exclude_colors = excludeColors;
            }
            
            // Advanced filters
            const transmission = $('#transmissionFilter').val();
            if (transmission && transmission.length > 0) {
                filters.transmission = transmission.join(',');
            }
            
            const drivetrain = $('#drivetrainFilter').val();
            if (drivetrain && drivetrain.length > 0) {
                filters.drivetrain = drivetrain.join(',');
            }
            
            const fuelType = $('#fuelTypeFilter').val();
            if (fuelType && fuelType.length > 0) {
                filters.fuel_type = fuelType.join(',');
            }
            
            // Features
            const features = [];
            $('.feature-checkbox input:checked').each(function() {
                features.push($(this).val());
            });
            if (features.length > 0) {
                filters.required_features = features.join(',');
            }
            
            // Efficiency
            if ($('#mpgCityMin').val()) filters.mpg_city_min = $('#mpgCityMin').val();
            if ($('#mpgHighwayMin').val()) filters.mpg_highway_min = $('#mpgHighwayMin').val();
            
            // History
            if ($('#cleanTitleOnly').is(':checked')) filters.clean_title_only = 'true';
            if ($('#noAccidents').is(':checked')) filters.no_accidents = 'true';
            if ($('#oneOwnerOnly').is(':checked')) filters.one_owner_only = 'true';
            
            return filters;
        }
        
        // Perform search
        async function performSearch(page = 1) {
            currentPage = page;
            currentQuery = $('#searchQuery').val();
            currentFilters = buildFilters();
            
            // Show loading
            $('.loading-overlay').css('display', 'flex');
            
            try {
                const params = new URLSearchParams({
                    query: currentQuery,
                    page: currentPage,
                    sort_by: $('#sortBy').val() || 'relevance',
                    ...currentFilters
                });
                
                if (selectedPreset) {
                    params.append('preset', selectedPreset);
                }
                
                const response = await fetch('/api/search/v2?' + params);
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data);
                } else {
                    alert('Search failed: ' + data.error);
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('An error occurred while searching. Please try again.');
            } finally {
                $('.loading-overlay').hide();
            }
        }
        
        // Display search results
        function displayResults(data) {
            // Update stats
            $('#resultCount').text(data.total.toLocaleString());
            if (data.search_time) {
                $('#searchTime').text(`(${data.search_time.toFixed(2)}s)`);
            }
            $('#searchStats').show();
            
            // Clear and populate results
            const container = $('#resultsContainer');
            container.empty();
            
            if (data.vehicles.length === 0) {
                container.html(`
                    <div class="col-12 text-center py-5">
                        <h4>No vehicles found</h4>
                        <p class="text-muted">Try adjusting your filters or search terms</p>
                    </div>
                `);
                $('#pagination').hide();
                return;
            }
            
            // Display vehicles
            data.vehicles.forEach(vehicle => {
                const imageUrl = vehicle.image_urls && vehicle.image_urls.length > 0 
                    ? vehicle.image_urls[0] 
                    : 'https://via.placeholder.com/300x200?text=No+Image';
                
                const features = vehicle.features && vehicle.features.length > 0
                    ? vehicle.features.slice(0, 3).map(f => `<span class="badge badge-secondary">${f.replace('_', ' ')}</span>`).join(' ')
                    : '';
                
                const card = `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card vehicle-card">
                            <img src="${imageUrl}" class="card-img-top" alt="${vehicle.year} ${vehicle.make} ${vehicle.model}" 
                                 style="height: 200px; object-fit: cover;">
                            <div class="card-body">
                                <h5 class="card-title">${vehicle.year} ${vehicle.make} ${vehicle.model}</h5>
                                <p class="card-text">
                                    <strong class="text-primary">$${vehicle.price.toLocaleString()}</strong>
                                    ${vehicle.mileage ? `<span class="text-muted"> | ${vehicle.mileage.toLocaleString()} miles</span>` : ''}
                                </p>
                                <p class="card-text">
                                    ${vehicle.body_style ? `<span class="badge badge-info">${vehicle.body_style}</span>` : ''}
                                    ${vehicle.exterior_color ? `<span class="badge badge-light">${vehicle.exterior_color}</span>` : ''}
                                    ${features}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">${vehicle.location || 'Location not specified'}</small>
                                    <a href="${vehicle.view_item_url}" target="_blank" class="btn btn-sm btn-primary">
                                        View Details <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(card);
            });
            
            // Update pagination
            updatePagination(data.page, data.pages);
        }
        
        // Update pagination
        function updatePagination(currentPage, totalPages) {
            if (totalPages <= 1) {
                $('#pagination').hide();
                return;
            }
            
            const pagination = $('#pagination ul');
            pagination.empty();
            
            // Previous button
            if (currentPage > 1) {
                pagination.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="performSearch(${currentPage - 1})">Previous</a>
                    </li>
                `);
            }
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                pagination.append(`
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="performSearch(${i})">${i}</a>
                    </li>
                `);
            }
            
            // Next button
            if (currentPage < totalPages) {
                pagination.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="performSearch(${currentPage + 1})">Next</a>
                    </li>
                `);
            }
            
            $('#pagination').show();
        }
        
        // Reset all filters
        function resetFilters() {
            // Clear all form inputs
            $('#makeFilter').val(null).trigger('change');
            $('#yearMin, #yearMax, #priceMin, #priceMax, #mileageMin, #mileageMax').val('');
            $('#excludeColors').val('');
            $('#mpgCityMin, #mpgHighwayMin').val('');
            $('#transmissionFilter, #drivetrainFilter, #fuelTypeFilter').val(null).trigger('change');
            
            // Clear selections
            selectedBodyStyles.clear();
            selectedColors.clear();
            selectedPreset = null;
            $('.body-style-icon, .color-swatch').removeClass('selected');
            $('.preset-card').removeClass('active');
            
            // Uncheck all checkboxes
            $('input[type="checkbox"]').prop('checked', false);
            
            // Clear search query
            $('#searchQuery').val('');
        }
        
        // Save current search
        function saveCurrentSearch() {
            if (!currentQuery && Object.keys(currentFilters).length === 0) {
                alert('Please perform a search first');
                return;
            }
            
            $('#saveSearchModal').modal('show');
        }
        
        // Confirm save search
        async function confirmSaveSearch() {
            const searchName = $('#searchName').val().trim();
            if (!searchName) {
                alert('Please enter a name for this search');
                return;
            }
            
            try {
                const response = await fetch('/api/search/v2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: currentQuery,
                        ...currentFilters,
                        save_search: 'true',
                        search_name: searchName,
                        user_id: getUserId()
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    $('#saveSearchModal').modal('hide');
                    alert('Search saved successfully!');
                    loadSavedSearches();
                } else {
                    alert('Failed to save search: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving search:', error);
                alert('An error occurred while saving the search');
            }
        }
        
        // Load saved searches
        async function loadSavedSearches() {
            const userId = getUserId();
            if (!userId) return;
            
            try {
                const response = await fetch(`/api/saved-searches?user_id=${userId}`);
                const data = await response.json();
                
                if (data.success && data.saved_searches.length > 0) {
                    let html = '<div class="list-group">';
                    data.saved_searches.forEach(search => {
                        html += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${search.name}</h6>
                                    <small class="text-muted">Created: ${new Date(search.created_at).toLocaleDateString()}</small>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="runSavedSearch(${search.id})">
                                    Run Search
                                </button>
                            </div>
                        `;
                    });
                    html += '</div>';
                    $('#savedSearchesList').html(html);
                }
            } catch (error) {
                console.error('Error loading saved searches:', error);
            }
        }
        
        // Run saved search
        async function runSavedSearch(searchId) {
            $('#savedSearchesModal').modal('hide');
            $('.loading-overlay').css('display', 'flex');
            
            try {
                const response = await fetch(`/api/saved-searches/${searchId}/run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: getUserId()
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    displayResults(data);
                } else {
                    alert('Failed to run saved search: ' + data.error);
                }
            } catch (error) {
                console.error('Error running saved search:', error);
                alert('An error occurred while running the saved search');
            } finally {
                $('.loading-overlay').hide();
            }
        }
        
        // Search for specific query
        function searchFor(query) {
            $('#searchQuery').val(query);
            performSearch();
        }
        
        // Get or create user ID
        function getUserId() {
            let userId = localStorage.getItem('userId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
            }
            return userId;
        }
    </script>
</body>
</html>