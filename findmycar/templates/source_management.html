<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Source Management - FindMyCar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
        }
        
        body {
            background-color: var(--light);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .container {
            max-width: 1200px;
            margin-top: 2rem;
        }
        
        .page-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        .page-subtitle {
            color: var(--secondary-color);
            font-size: 1.1rem;
        }
        
        .source-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .source-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .source-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .source-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .source-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }
        
        .source-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .type-api {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .type-rss {
            background: #fef3c7;
            color: #92400e;
        }
        
        .type-scrape {
            background: #ede9fe;
            color: #5b21b6;
        }
        
        .source-description {
            color: var(--secondary-color);
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }
        
        .source-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .status-healthy {
            background: var(--success-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .status-unhealthy {
            background: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        
        .status-unknown {
            background: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.2);
        }
        
        .source-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .stats-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--secondary-color);
            font-size: 0.95rem;
        }
        
        .health-check-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .health-check-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }
        
        .alert {
            border-radius: 8px;
            border: none;
            padding: 1rem 1.5rem;
        }
        
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Vehicle Source Management</h1>
            <p class="page-subtitle">Configure and monitor vehicle data sources</p>
            <div class="mt-3">
                <a href="/" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Search
                </a>
                <button class="health-check-btn ms-2" onclick="runHealthCheck()">
                    <i class="fas fa-heartbeat me-2"></i>Run Health Check
                </button>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="stats-container">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalSources">0</div>
                    <div class="stat-label">Total Sources</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="enabledSources">0</div>
                    <div class="stat-label">Enabled Sources</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="healthySources">0</div>
                    <div class="stat-label">Healthy Sources</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="apiSources">0</div>
                    <div class="stat-label">API Sources</div>
                </div>
            </div>
        </div>
        
        <!-- Alert Container -->
        <div id="alertContainer"></div>
        
        <!-- Sources Grid -->
        <div class="source-grid" id="sourcesGrid">
            <!-- Sources will be populated here -->
        </div>
    </div>
    
    <script>
        let sourceData = {};
        
        // Load source data on page load
        window.addEventListener('DOMContentLoaded', loadSources);
        
        async function loadSources() {
            try {
                const response = await fetch('/api/sources/stats');
                const data = await response.json();
                sourceData = data;
                updateUI(data);
            } catch (error) {
                showAlert('Error loading sources: ' + error.message, 'danger');
            }
        }
        
        function updateUI(data) {
            // Update statistics
            document.getElementById('totalSources').textContent = data.total_sources || 0;
            document.getElementById('enabledSources').textContent = data.enabled_sources || 0;
            document.getElementById('apiSources').textContent = 
                Object.values(data.source_types || {}).find((v, i) => Object.keys(data.source_types)[i] === 'api') || 0;
            
            // Update sources grid
            const grid = document.getElementById('sourcesGrid');
            grid.innerHTML = '';
            
            if (data.sources) {
                Object.entries(data.sources).forEach(([name, source]) => {
                    const card = createSourceCard(name, source, data.health_status?.[name]);
                    grid.appendChild(card);
                });
            }
            
            // Update healthy count if health data available
            if (data.health_status) {
                const healthyCount = Object.values(data.health_status)
                    .filter(h => h.status === 'healthy').length;
                document.getElementById('healthySources').textContent = healthyCount;
            }
        }
        
        function createSourceCard(name, source, health) {
            const card = document.createElement('div');
            card.className = 'source-card';
            
            const typeClass = `type-${source.type}`;
            const statusClass = health ? `status-${health.status}` : 'status-unknown';
            const isChecked = source.enabled ? 'checked' : '';
            
            card.innerHTML = `
                <div class="source-header">
                    <div>
                        <div class="source-name">${capitalizeFirst(name)}</div>
                        <span class="source-type ${typeClass}">${source.type}</span>
                    </div>
                </div>
                <div class="source-description">${source.description}</div>
                <div class="source-status">
                    <div class="status-indicator ${statusClass}"></div>
                    <span>${health ? health.message : 'Status unknown'}</span>
                </div>
                <div class="source-toggle">
                    <span>Enabled</span>
                    <label class="toggle-switch">
                        <input type="checkbox" ${isChecked} onchange="toggleSource('${name}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            `;
            
            return card;
        }
        
        async function toggleSource(sourceName, enabled) {
            try {
                const response = await fetch(`/api/sources/${sourceName}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                
                if (response.ok) {
                    showAlert(`${capitalizeFirst(sourceName)} ${enabled ? 'enabled' : 'disabled'}`, 'success');
                    loadSources(); // Reload data
                } else {
                    throw new Error('Failed to toggle source');
                }
            } catch (error) {
                showAlert('Error toggling source: ' + error.message, 'danger');
                loadSources(); // Reload to reset toggle
            }
        }
        
        async function runHealthCheck() {
            const btn = document.querySelector('.health-check-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Checking...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/sources/health-check', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.health_status) {
                    sourceData.health_status = data.health_status;
                    updateUI(sourceData);
                    showAlert('Health check completed', 'success');
                }
            } catch (error) {
                showAlert('Error running health check: ' + error.message, 'danger');
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }
        
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1).replace(/_/g, ' ');
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>