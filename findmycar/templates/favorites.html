<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Favorites - CarGPT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-heart"></i> My Favorites</h1>
                    <p class="subtitle">Your saved vehicles and watchlist</p>
                </div>
                <div class="header-actions">
                    <a href="/" class="btn btn-outline-light">
                        <i class="fas fa-search"></i> Back to Search
                    </a>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        {% if vehicles %}
        <!-- Favorites Summary -->
        <section class="results-header">
            <h3 class="results-count">
                <i class="fas fa-heart text-danger"></i> 
                {{ total_favorites }} Favorite{{ 's' if total_favorites != 1 else '' }}
            </h3>
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-outline-danger btn-sm" onclick="clearAllFavorites()">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>
        </section>
        
        <!-- Vehicle Grid -->
        <div class="vehicle-grid">
            {% for vehicle in vehicles %}
            <div class="vehicle-card" data-vehicle-id="{{ vehicle.id }}">
                <!-- Vehicle Image -->
                {% if vehicle.image_urls and vehicle.image_urls|length > 0 %}
                <img src="{{ vehicle.image_urls[0] }}" class="card-img-top" alt="{{ vehicle.title }}" 
                     onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                {% else %}
                <img src="https://via.placeholder.com/300x200?text=No+Image" class="card-img-top" alt="No image available">
                {% endif %}
                
                <div class="card-body">
                    <!-- Deal Rating Badge -->
                    {% if vehicle.deal_rating %}
                    <div class="deal-badge {{ 'great-deal' if vehicle.deal_rating == 'Great Deal' else 'good-deal' if vehicle.deal_rating == 'Good Deal' else 'fair-price' if vehicle.deal_rating == 'Fair Price' else 'high-price' }}">
                        <i class="fas fa-{{ 'star' if vehicle.deal_rating == 'Great Deal' else 'thumbs-up' if vehicle.deal_rating == 'Good Deal' else 'balance-scale' if vehicle.deal_rating == 'Fair Price' else 'exclamation-triangle' }}"></i>
                        {{ vehicle.deal_rating }}
                    </div>
                    {% endif %}
                    
                    <!-- Source Badge -->
                    <div class="source-badge mb-3">
                        {% if vehicle.source == 'ebay' %}
                        <span class="badge badge-primary">
                            <i class="fab fa-ebay"></i> eBay Motors
                        </span>
                        {% else %}
                        <span class="badge badge-secondary">
                            <i class="fas fa-car"></i> {{ vehicle.source|title }}
                        </span>
                        {% endif %}
                    </div>
                    
                    <!-- Vehicle Title -->
                    <h5 class="card-title">{{ vehicle.title }}</h5>
                    
                    <!-- Price Section -->
                    <div class="price-section">
                        <div class="price-main">
                            <span class="price-label">Asking Price</span>
                            <span class="price-value">${{ "${:,.0f}".format(vehicle.price) if vehicle.price else 'N/A' }}</span>
                        </div>
                        
                        {% if vehicle.estimated_value %}
                        <div class="price-details">
                            Est. Value: ${{ "${:,.0f}".format(vehicle.estimated_value) }}
                            {% if vehicle.price and vehicle.estimated_value %}
                                {% set savings = vehicle.estimated_value - vehicle.price %}
                                {% if savings > 0 %}
                                    <span class="text-success">(${{ "${:,.0f}".format(savings) }} below market)</span>
                                {% else %}
                                    <span class="text-warning">(${{ "${:,.0f}".format(-savings) }} above market)</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        <!-- Price Progress Bar -->
                        {% if vehicle.price and vehicle.estimated_value %}
                            {% set price_ratio = (vehicle.price / vehicle.estimated_value) * 100 %}
                            <div class="price-progress">
                                <div class="progress-bar 
                                    {{ 'bg-success' if price_ratio <= 90 else 'bg-primary' if price_ratio <= 100 else 'bg-warning' if price_ratio <= 110 else 'bg-danger' }}" 
                                    style="width: {{ [price_ratio, 100]|min }}%"></div>
                            </div>
                        {% endif %}
                        {% endif %}
                    </div>
                    
                    <!-- Vehicle Details -->
                    <div class="vehicle-details">
                        {% if vehicle.year or vehicle.make or vehicle.model %}
                        <div class="detail-row">
                            <span class="detail-label">Vehicle</span>
                            <span class="detail-value">
                                {{ vehicle.year or '' }} {{ vehicle.make or '' }} {{ vehicle.model or '' }}
                            </span>
                        </div>
                        {% endif %}
                        
                        {% if vehicle.mileage %}
                        <div class="detail-row">
                            <span class="detail-label">Mileage</span>
                            <span class="detail-value">{{ "{:,}".format(vehicle.mileage) }} miles</span>
                        </div>
                        {% endif %}
                        
                        {% if vehicle.condition %}
                        <div class="detail-row">
                            <span class="detail-label">Condition</span>
                            <span class="detail-value">{{ vehicle.condition }}</span>
                        </div>
                        {% endif %}
                        
                        {% if vehicle.location %}
                        <div class="detail-row">
                            <span class="detail-label">Location</span>
                            <span class="detail-value">{{ vehicle.location }}</span>
                        </div>
                        {% endif %}
                        
                        {% if vehicle.transmission %}
                        <div class="detail-row">
                            <span class="detail-label">Transmission</span>
                            <span class="detail-value">{{ vehicle.transmission }}</span>
                        </div>
                        {% endif %}
                        
                        {% if vehicle.fuel_type %}
                        <div class="detail-row">
                            <span class="detail-label">Fuel Type</span>
                            <span class="detail-value">{{ vehicle.fuel_type }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <a href="{{ vehicle.view_item_url }}" target="_blank" class="btn btn-outline-info">
                            <i class="fas fa-external-link-alt"></i> View Listing
                        </a>
                        <button class="btn btn-outline-success" onclick="generateMessage({{ vehicle.id }}, 'inquiry')">
                            <i class="fas fa-envelope"></i> Contact Seller
                        </button>
                        <button class="btn btn-outline-danger favorite-btn" onclick="removeFavorite({{ vehicle.id }})">
                            <i class="fas fa-heart-broken"></i> Remove from Favorites
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% else %}
        <!-- Empty State -->
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-heart-broken text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
            </div>
            <h3 class="text-muted mb-3">No Favorites Yet</h3>
            <p class="text-muted mb-4">
                Start browsing vehicles and click the <i class="fas fa-heart text-danger"></i> button to save your favorites here.
            </p>
            <a href="/" class="btn btn-primary">
                <i class="fas fa-search"></i> Browse Vehicles
            </a>
        </div>
        {% endif %}
    </div>
    
    <!-- Toast Notifications Container -->
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>
    
    <!-- Message Generation Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-envelope"></i> Contact Seller
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="messageContent">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Generating message...</span>
                            </div>
                            <p class="mt-2">Generating personalized message...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="copyMessageBtn" style="display: none;" onclick="copyMessage()">
                        <i class="fas fa-copy"></i> Copy Message
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Remove after delay
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Remove single favorite
        function removeFavorite(vehicleId) {
            if (!confirm('Remove this vehicle from your favorites?')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('vehicle_id', vehicleId);
            
            fetch('/favorites/toggle', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the card from view
                    const card = document.querySelector(`[data-vehicle-id="${vehicleId}"]`);
                    if (card) {
                        card.style.transition = 'opacity 0.3s ease-out';
                        card.style.opacity = '0';
                        setTimeout(() => {
                            card.remove();
                            // Check if any vehicles remain
                            const remainingCards = document.querySelectorAll('.vehicle-card').length;
                            if (remainingCards === 0) {
                                location.reload(); // Reload to show empty state
                            }
                        }, 300);
                    }
                    showToast('Vehicle removed from favorites');
                } else {
                    showToast('Failed to remove favorite', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to remove favorite', 'error');
            });
        }
        
        // Clear all favorites
        function clearAllFavorites() {
            if (!confirm('Remove all vehicles from your favorites? This action cannot be undone.')) {
                return;
            }
            
            // Get all vehicle IDs
            const vehicleCards = document.querySelectorAll('.vehicle-card');
            const promises = [];
            
            vehicleCards.forEach(card => {
                const vehicleId = card.getAttribute('data-vehicle-id');
                const formData = new FormData();
                formData.append('vehicle_id', vehicleId);
                
                promises.push(
                    fetch('/favorites/toggle', {
                        method: 'POST',
                        body: formData
                    })
                );
            });
            
            Promise.all(promises)
                .then(() => {
                    showToast('All favorites cleared');
                    setTimeout(() => location.reload(), 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Failed to clear all favorites', 'error');
                });
        }
        
        // Generate message for seller
        function generateMessage(vehicleId, messageType) {
            $('#messageModal').modal('show');
            $('#messageContent').html(`
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Generating message...</span>
                    </div>
                    <p class="mt-2">Generating personalized message...</p>
                </div>
            `);
            $('#copyMessageBtn').hide();
            
            const formData = new FormData();
            formData.append('vehicle_id', vehicleId);
            formData.append('message_type', messageType);
            
            fetch('/generate-message', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    $('#messageContent').html(`
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            This is an AI-generated message template. Feel free to personalize it before sending.
                        </div>
                        <div class="form-group">
                            <label for="generatedMessage"><strong>Generated Message:</strong></label>
                            <textarea id="generatedMessage" class="form-control" rows="8" readonly>${data.message}</textarea>
                        </div>
                    `);
                    $('#copyMessageBtn').show();
                } else {
                    $('#messageContent').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            Failed to generate message: ${data.error || 'Unknown error'}
                        </div>
                    `);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                $('#messageContent').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to generate message. Please try again.
                    </div>
                `);
            });
        }
        
        // Copy message to clipboard
        function copyMessage() {
            const messageText = document.getElementById('generatedMessage');
            messageText.select();
            messageText.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                showToast('Message copied to clipboard!');
                $('#messageModal').modal('hide');
            } catch (err) {
                console.error('Failed to copy message:', err);
                showToast('Failed to copy message', 'error');
            }
        }
    </script>
</body>
</html>